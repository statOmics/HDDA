---
title: "Lab 5: Clustering"
subtitle: "High Dimensional Data Analysis practicals"
author: "Milan Malfait and Leo Fuhrhop"
date: "24 Feb 2022 <br/> (Last updated: 2025-11-09)"
references:
- id: esl-book
  type: book
  author:
  - family: Hastie
    given: Trevor
  - family: Tibshirani
    given: Robert
  - family: Friedman
    given: Jerome
  issued:
  - year: 2009
  title: The Elements of Statistical Learning
  publisher: Springer
  edition: 2nd
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.show = "hold"
)

options(width = 80)
```

### [Change log](https://github.com/statOmics/HDDA/commits/master/Lab6-Clustering.Rmd) {-}

***

```{r libraries, message=FALSE, warning=FALSE}
## Install necessary packages with:

# install.packages(c("mclust", "gclus", "tidyverse", "gridExtra"))

# if (!requireNamespace("remotes", quietly = TRUE)) {
#     install.packages("remotes")
# }
# remotes::install_github("vqv/ggbiplot")

library(mclust)
library(gclus)  # contains the 'wine' data
library(ggbiplot)
library(tidyverse)
library(gridExtra)

theme_set(theme_minimal())
```


# The wine data

In this lab session, we will explore the [`wine`][wine] data, following the
example analysis from [Scrucca *et al.* (2016)][scrucca2016].

This dataset provides 13 measurements obtained from a chemical analysis of 178
wines grown in the same region in Italy but derived from three different
cultivars (Barolo, Grignolino, Barbera). The original cultivar labels are
provided in the dataset.

We will apply different clustering algorithms and validate them by comparing how
well the clusters capture the original classes.

```{r}
data("wine", package = "gclus")
class <- factor(wine$Class, levels = 1:3, labels = c("Barolo", "Grignolino", "Barbera"))
table(class)

X <- as.matrix(wine[, -1])
summary(X)
```

We will use a PCA to visualize the data, along with the class labels, in a low-dimensional space.
This will allow us to interpret the results of the clustering algorithms more easily.

### Tasks {-}

#### 1. Perform a PCA of the scaled `wine` data. {-}

<details><summary>Solution</summary>

```{r}
wine_pca <- prcomp(X, scale. = TRUE)
```

</details>

#### 2. Create a biplot of the first two PCs. Color each observation by its class label. Interpret the PCs. How distinguishable are the classes with respect to the PCs? {-}

<details><summary>Solution</summary>

Using `ggbiplot`:

```{r}
cols <- c("Barolo" = "#28a028", "Grignolino" = "#da6852", "Barbera" = "#0078cd")

ggbiplot(wine_pca, groups = class) +
  scale_color_manual(values = cols) +
  labs(color = "True labels") +
  theme(aspect.ratio = 0.8, legend.position = "top")
```

Alternatively, using base `R` plotting:

```{r}
Zk <- wine_pca$x[, 1:2]
Vk <- wine_pca$rotation[, 1:2]

plot(Zk, pch = 20,
  col = cols[class],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(class),
  col = cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}
```

__Interpretation__: Low values on PC1 correspond to heavier, aged, more structured wines, while high values indicate fresher, less heavy, younger wines. 
High values on PC2 correspond to lighter-colored wines with lower alcohol content.
Importantly, the three classes are quite clearly visually separated with little overlap between them. We can thus rely on the biplot to visually investigate how well a clustering algorithm recovers the true classes. 

</details>

# Hierarchical clustering

### Tasks {-}

#### 1. Perform hierarchical clustering of the wine data, using a Euclidean distance matrix and the complete-linkage algorithm (see `?hclust`). {-}

<details><summary>Solution</summary>

```{r}
# Calculate distance matrix and perform hierarchical clustering
wine_dist <- dist(X, method = "euclidean")
hc <- hclust(wine_dist, method = "complete")
```

</details>

#### 2. Plot the clustering *dendrogram*. {-}

<details><summary>Solution</summary>

```{r}
plot(hc, labels = FALSE)
```

</details>

#### 3. Use `cutree` to select three clusters from the hierarchical clustering. Recreate the PCA biplot from Section 1, but color each observation according to its cluster. Compare the resulting biplot to the earlier one from Section 1. {-}

<details><summary>Solution</summary>

```{r}
# Select three clusters
hc_clusters <- cutree(hc, k = 3)
# Tabulate clusters against true classes
table(class, hc_clusters)
```

Biplot with `ggbiplot`:

```{r}
plot1 <- ggbiplot(wine_pca, groups = class) +
  scale_color_manual(values = cols) +
  labs(color = "True labels") +
  theme(aspect.ratio = 0.8, legend.position = "top")

plot2 <- ggbiplot(wine_pca, groups = factor(hc_clusters)) +
  scale_color_manual(values = c("#9d05f4", "#01d9d9", "#f4dc00")) +
  labs(color = "HC clusters") +
  theme(aspect.ratio = 0.8, legend.position = "top")

grid.arrange(plot1, nullGrob(), plot2, ncol = 3, widths = c(1, 0.1, 1))
```

Alternatively, using base `R` plotting:

```{r}
par(mfrow = c(1, 2))

# True class labels
plot(Zk, pch = 20,
  col = cols[class],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(class),
  col = cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}

cluster_cols <- c("1" = "#9d05f4", "2" = "#01d9d9", "3" = "#f4dc00")
# Clusters
plot(Zk, pch = 20,
  col = cluster_cols[factor(hc_clusters)],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(factor(hc_clusters)),
  col = cluster_cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}
```

__Interpretation__: The first cluster corresponds to most of the Barolo class, but the second cluster overlaps with all three classes, and the third cluster captures wines from both the Grignolino and the Barbera class.
Overall, the three clusters do not recover the true class labels.

</details>

#### Bonus: can you improve the results by using different distance metrics or linkages? {-}


# Model-based clustering

### Tasks {-}

#### 1. Use `mclust::Mclust()` to perform model-based clustering on the `wine` data. {-}

<details><summary>Solution</summary>

```{r}
mc <- Mclust(X)
summary(mc)
summary(mc$BIC)
```

</details>

#### 2. Visualize the clustering via pairwise plots. Plot the BIC (Bayesian information criterion) values and interpret the results. {-}

Hint: Check `?plot.Mclust`.

<details><summary>Solution</summary>

```{r}
# Pairwise clustering plots
plot(mc, what = "classification")

# BIC plot; exclude two models with very low BIC
plot(mc, what = "BIC", ylim = range(mc$BIC[, -(1:2)], na.rm = TRUE),
  legendArgs = list(x = "bottomleft")
)
```

__Interpretation__: A three-component mixture with covariances having
different shapes and volumes but the same orientation (VVE) results in the
highest BIC. 

</details>

#### 3. Recreate the PCA biplot from Section 1, but color each observation according to its cluster. Compare the resulting biplot to the earlier ones. {-}

<details><summary>Solution</summary>

```{r}
# Tabulate clusters against true classes
table(class, mc$classification)
```

Biplot with `ggbiplot`:

```{r}
plot1 <- ggbiplot(wine_pca, groups = class) +
  scale_color_manual(values = cols) +
  labs(color = "True labels") +
  theme(aspect.ratio = 0.8, legend.position = "top")

plot2 <- ggbiplot(wine_pca, groups = factor(mc$classification)) +
  scale_color_manual(values = c("#9d05f4", "#01d9d9", "#f4dc00")) +
  labs(color = "Mclust clusters") +
  theme(aspect.ratio = 0.8, legend.position = "top")

grid.arrange(plot1, nullGrob(), plot2, ncol = 3, widths = c(1, 0.1, 1))
```

Alternatively, using base `R` plotting:

```{r}
par(mfrow = c(1, 2))

# True class labels
plot(Zk, pch = 20,
  col = cols[class],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(class),
  col = cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}

cluster_cols <- c("1" = "#9d05f4", "2" = "#01d9d9", "3" = "#f4dc00")
# Clusters
plot(Zk, pch = 20,
  col = cluster_cols[factor(mc$classification)],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(factor(mc$classification)),
  col = cluster_cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}
```

__Interpretation__: The first cluster corresponds to the Barolo class, the second cluster to the Grignolino class and the third cluster to Barbera. 
Overall, the three clusters recover the true class labels very well, with only two Grignolino wines falsely assigned to the third cluster (Barbera).

</details>


#### 4. Select an appropriate number of PCs from the PCA. Repeat the model-based clustering on the PCs. How do the results compare to those on the full data? {-}

<details><summary>Solution</summary>
```{r}
# Proportion of variance explained by each PC
wine_prop_var <- data.frame(
  PC = 1:ncol(wine_pca$x),
  var = wine_pca$sdev^2 / sum(wine_pca$sdev^2)
)

ggplot(wine_prop_var, aes(PC, var)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = 7.5, col = "firebrick") +
  scale_x_continuous(breaks = 1:ncol(wine_pca$x)) +
  labs(y = "Proportion of variance")
```

The first 7 PCs explain about 92% of the variance in the `wine` data.

```{r}
# Select the first k PCs
k <- 7
pca_X <- wine_pca$x[, 1:k]

# Refit the model-based clustering
mc2 <- Mclust(pca_X)
summary(mc2)
summary(mc2$BIC)
```

A five-component mixture with diagonal covariances having equal shape, but
varying volume (VEI), results in the highest BIC. 

```{r}
# Tabulate clusters against true classes
table(class, mc2$classification)
```

Biplot with `ggbiplot`:

```{r}
plot1 <- ggbiplot(wine_pca, groups = class) +
  scale_color_manual(values = cols) +
  labs(color = "True labels") +
  theme(aspect.ratio = 0.8, legend.position = "top")

plot2 <- ggbiplot(wine_pca, groups = factor(mc2$classification)) +
  scale_color_manual(values = c("#9d05f4", "#01d9d9", "#01d9d9", "#01d9d9", "#f4dc00")) +
  labs(color = "Mclust clusters") +
  theme(aspect.ratio = 0.8, legend.position = "top")

grid.arrange(plot1, nullGrob(), plot2, ncol = 3, widths = c(1, 0.1, 1))
```

Alternatively, using base `R` plotting:

```{r}
par(mfrow = c(1, 2))

# True class labels
plot(Zk, pch = 20,
  col = cols[class],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(class),
  col = cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}

cluster_cols <- c("1" = "#9d05f4", "2" = "#01d9d9", "3" = "#01d9d9", "4" = "#01d9d9", "5" = "#f4dc00")
# Clusters
plot(Zk, pch = 20,
  col = cluster_cols[factor(mc2$classification)],
  xlab = "PC1", ylab = "PC2"
)
legend("topleft", levels(factor(mc2$classification)),
  col = cluster_cols,
  pch = 19
)
alpha <- 5 # rescaling
for (i in 1:13) {
  arrows(0, 0, alpha * Vk[i, 1], alpha * Vk[i, 2], length = 0.2, col = "#8f4040")
  text(alpha * Vk[i, 1], alpha * Vk[i, 2], rownames(Vk)[i], col = "#8f4040")
}
```

__Interpretation__: The first cluster corresponds to most of the Barolo class. The fifth color mainly corresponds to the Barbera class, while containing a few Grignolino wines.
Combining the second, third and fourth cluster recovers most of the Grignolino class, with some overlap with the remaining classes.
Overall, after combining the three smaller clusters, the clustering recovers the true class labels fairly well, though not quite as closely as the clustering on the original data.

</details>

# Additional resources {-}
- Section 14.3 of @esl-book


```{r, child="_session-info.Rmd"}
```

[wine]: https://rdrr.io/cran/gclus/man/wine.html
[scrucca2016]: https://svn.r-project.org/Rjournal/html/archive/2016/RJ-2016-021/RJ-2016-021.pdf

# References {-}